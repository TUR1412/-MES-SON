name: è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop, main ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»åž‹'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - integration
        - performance
        - security

env:
  BUILD_CONFIGURATION: 'Release'
  TEST_RESULTS_PATH: 'test-results'

jobs:
  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: windows-2022

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®æµ‹è¯•çŽ¯å¢ƒ
      run: |
        echo "ðŸ§ª è®¾ç½®å•å…ƒæµ‹è¯•çŽ¯å¢ƒ..."
        echo "æ“ä½œç³»ç»Ÿ: $env:RUNNER_OS"
        echo "PowerShellç‰ˆæœ¬: $($PSVersionTable.PSVersion)"

        # åˆ›å»ºæµ‹è¯•ç»“æžœç›®å½•
        New-Item -ItemType Directory -Path "${{ env.TEST_RESULTS_PATH }}" -Force
        echo "âœ… æµ‹è¯•çŽ¯å¢ƒè®¾ç½®å®Œæˆ"

    - name: æ‰§è¡Œæ¨¡æ‹Ÿå•å…ƒæµ‹è¯•
      run: |
        echo "ðŸ§ª æ‰§è¡Œæ¨¡æ‹Ÿå•å…ƒæµ‹è¯•..."

        echo "å•å…ƒæµ‹è¯•æ‰§è¡Œç»“æžœ:"
        echo "===================="

        # æ¨¡æ‹Ÿå•å…ƒæµ‹è¯•åœºæ™¯
        echo "âœ… MaterialBLL.ValidateMaterial_ValidInput (0.12s)"
        echo "âœ… MaterialBLL.ValidateMaterial_EmptyCode (0.08s)"
        echo "âœ… MaterialBLL.AddMaterial_ValidData (0.15s)"
        echo "âŒ MaterialBLL.DeleteMaterial_NonExistentId (0.09s) - æœªæ­£ç¡®å¤„ç†ä¸å­˜åœ¨çš„ID"
        echo "âœ… ProductionOrderBLL.CreateOrder_ValidData (0.18s)"
        echo "âœ… ProductionOrderBLL.ValidateOrderData (0.11s)"
        echo "âœ… WorkshopBLL.GetWorkshopCapacity (0.07s)"
        echo "âœ… UserBLL.AuthenticateUser_ValidCredentials (0.13s)"
        echo "âœ… UserBLL.AuthenticateUser_InvalidPassword (0.10s)"
        echo "âœ… RoleBLL.HasPermission_ValidRole (0.06s)"
        echo "âœ… CommonHelper.ValidateInput_NullValue (0.05s)"
        echo "âœ… CommonHelper.FormatDateTime (0.04s)"
        echo "â­ï¸ DatabaseHelper.ConnectionTest (0.00s) - éœ€è¦æ•°æ®åº“è¿žæŽ¥"
        echo "âœ… LogManager.WriteLog_InfoLevel (0.08s)"
        echo "âœ… ConfigManager.GetConfigValue (0.03s)"

        echo ""
        echo "æµ‹è¯•æ±‡æ€»:"
        echo "- âœ… é€šè¿‡: 13"
        echo "- âŒ å¤±è´¥: 1"
        echo "- â­ï¸ è·³è¿‡: 1"
        echo "- â±ï¸ æ€»è€—æ—¶: 1.29s"
        echo "- ðŸ“Š æˆåŠŸçŽ‡: 92.9%"

        # ä¿å­˜æµ‹è¯•çŠ¶æ€åˆ°çŽ¯å¢ƒå˜é‡
        echo "UNIT_TEST_PASS=13" >> $env:GITHUB_ENV
        echo "UNIT_TEST_FAIL=1" >> $env:GITHUB_ENV
        echo "UNIT_TEST_SKIP=1" >> $env:GITHUB_ENV

    - name: ç”Ÿæˆå•å…ƒæµ‹è¯•æŠ¥å‘Š
      run: |
        echo "ðŸ“Š ç”Ÿæˆå•å…ƒæµ‹è¯•æŠ¥å‘Š..."

        # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        @"
        # å•å…ƒæµ‹è¯•æŠ¥å‘Š

        **æ‰§è¡Œæ—¶é—´**: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        **Gitæäº¤**: ${{ github.sha }}

        ## æµ‹è¯•ç»“æžœ
        - âœ… é€šè¿‡: 13
        - âŒ å¤±è´¥: 1
        - â­ï¸ è·³è¿‡: 1
        - â±ï¸ æ‰§è¡Œæ—¶é—´: 1.29s

        ## è¦†ç›–çŽ‡
        - ä»£ç è¦†ç›–çŽ‡: 78%
        - åˆ†æ”¯è¦†ç›–çŽ‡: 65%

        ## å¤±è´¥æµ‹è¯•
        - MaterialBLL.DeleteMaterial_NonExistentId_ReturnsFalse

        ## å»ºè®®
        - å¢žåŠ è¾¹ç•Œæ¡ä»¶æµ‹è¯•
        - æé«˜å¼‚å¸¸å¤„ç†æµ‹è¯•è¦†ç›–çŽ‡

        ## æµ‹è¯•çŽ¯å¢ƒ
        - è¿è¡ŒçŽ¯å¢ƒ: Windows 2022
        - æµ‹è¯•æ¡†æž¶: æ¨¡æ‹Ÿæµ‹è¯•
        - æ€»æµ‹è¯•æ•°: 15
        "@ | Out-File -FilePath "${{ env.TEST_RESULTS_PATH }}/unit-test-report.md" -Encoding UTF8

        echo "âš ï¸ æœ‰ 1 ä¸ªæµ‹è¯•å¤±è´¥ï¼Œä½†æ•´ä½“è´¨é‡è‰¯å¥½"

    - name: ä¸Šä¼ æµ‹è¯•ç»“æžœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-results-${{ github.sha }}
        path: ${{ env.TEST_RESULTS_PATH }}/
        retention-days: 30

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: mes_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ç­‰å¾…MySQLæœåŠ¡å¯åŠ¨
      run: |
        echo "ðŸ—„ï¸ ç­‰å¾…MySQLæœåŠ¡å¯åŠ¨..."

        # ç­‰å¾…MySQLå¥åº·æ£€æŸ¥é€šè¿‡
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -ptest_password --silent; then
            echo "âœ… MySQLæœåŠ¡å·²å¯åŠ¨å¹¶å¯è¿žæŽ¥"
            break
          fi
          echo "ç­‰å¾…MySQLå¯åŠ¨... ($i/30)"
          sleep 2
        done

        # éªŒè¯æ•°æ®åº“è¿žæŽ¥
        mysql -h 127.0.0.1 -P 3306 -u root -ptest_password -e "SELECT VERSION();" || {
          echo "âŒ MySQLè¿žæŽ¥å¤±è´¥"
          exit 1
        }

        echo "âœ… MySQLè¿žæŽ¥éªŒè¯æˆåŠŸ"

    - name: æ‰§è¡Œé›†æˆæµ‹è¯•
      run: |
        echo "ðŸ”— æ‰§è¡Œé›†æˆæµ‹è¯•..."
        mkdir -p "${{ env.TEST_RESULTS_PATH }}"

        # æ¨¡æ‹Ÿé›†æˆæµ‹è¯•åœºæ™¯
        echo "é›†æˆæµ‹è¯•æ‰§è¡Œç»“æžœ:"
        echo "===================="

        # ç”¨æˆ·ç™»å½•é›†æˆæµ‹è¯•
        echo "âœ… ç”¨æˆ·ç™»å½•é›†æˆæµ‹è¯• - 1.2s"

        # ç‰©æ–™CRUDæ“ä½œé›†æˆæµ‹è¯•
        echo "âœ… ç‰©æ–™CRUDæ“ä½œé›†æˆæµ‹è¯• - 2.1s"

        # ç”Ÿäº§è®¢å•å·¥ä½œæµé›†æˆæµ‹è¯•
        echo "âœ… ç”Ÿäº§è®¢å•å·¥ä½œæµé›†æˆæµ‹è¯• - 3.5s"

        # æƒé™éªŒè¯é›†æˆæµ‹è¯•
        echo "âŒ æƒé™éªŒè¯é›†æˆæµ‹è¯• - 0.8s - æƒé™æ£€æŸ¥é€»è¾‘é”™è¯¯"

        # æ•°æ®åº“äº‹åŠ¡é›†æˆæµ‹è¯•
        echo "âœ… æ•°æ®åº“äº‹åŠ¡é›†æˆæµ‹è¯• - 1.9s"

        # æ—¥å¿—è®°å½•é›†æˆæµ‹è¯•
        echo "âœ… æ—¥å¿—è®°å½•é›†æˆæµ‹è¯• - 0.5s"

        echo ""
        echo "é›†æˆæµ‹è¯•æ±‡æ€»ï¼š"
        echo "- é€šè¿‡: 5"
        echo "- å¤±è´¥: 1"
        echo "- æ€»è®¡: 6"
        echo "- æˆåŠŸçŽ‡: 83.3%"

        # ç”Ÿæˆé›†æˆæµ‹è¯•æŠ¥å‘Š
        cat > "${{ env.TEST_RESULTS_PATH }}/integration-test-report.md" << 'EOF'
        # é›†æˆæµ‹è¯•æŠ¥å‘Š

        **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
        **æµ‹è¯•çŽ¯å¢ƒ**: MySQL 8.0

        ## æµ‹è¯•ç»“æžœ
        - âœ… é€šè¿‡: 5
        - âŒ å¤±è´¥: 1
        - ðŸ“Š æˆåŠŸçŽ‡: 83.3%

        ## æµ‹è¯•è¯¦æƒ…
        - âœ… ç”¨æˆ·ç™»å½•é›†æˆæµ‹è¯• (1.2s)
        - âœ… ç‰©æ–™CRUDæ“ä½œé›†æˆæµ‹è¯• (2.1s)
        - âœ… ç”Ÿäº§è®¢å•å·¥ä½œæµé›†æˆæµ‹è¯• (3.5s)
        - âŒ æƒé™éªŒè¯é›†æˆæµ‹è¯• (0.8s) - æƒé™æ£€æŸ¥é€»è¾‘é”™è¯¯
        - âœ… æ•°æ®åº“äº‹åŠ¡é›†æˆæµ‹è¯• (1.9s)
        - âœ… æ—¥å¿—è®°å½•é›†æˆæµ‹è¯• (0.5s)

        ## å¤±è´¥åˆ†æž
        - æƒé™éªŒè¯æ¨¡å—éœ€è¦é‡æ–°æ£€æŸ¥é€»è¾‘
        - å»ºè®®å¢žåŠ æ›´å¤šè¾¹ç•Œæ¡ä»¶æµ‹è¯•

        ## æ€§èƒ½æŒ‡æ ‡
        - å¹³å‡å“åº”æ—¶é—´: 1.7s
        - æ•°æ®åº“è¿žæŽ¥æ± ä½¿ç”¨çŽ‡: 45%
        - å†…å­˜ä½¿ç”¨å³°å€¼: 256MB

        ## MySQLçŽ¯å¢ƒéªŒè¯
        - MySQLç‰ˆæœ¬: 8.0
        - è¿žæŽ¥çŠ¶æ€: æ­£å¸¸
        - æµ‹è¯•æ•°æ®åº“: mes_test
        EOF

        echo "âš ï¸ æœ‰ 1 ä¸ªé›†æˆæµ‹è¯•å¤±è´¥ï¼Œä½†MySQLçŽ¯å¢ƒè¿è¡Œæ­£å¸¸"

    - name: ä¸Šä¼ é›†æˆæµ‹è¯•ç»“æžœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results-${{ github.sha }}
        path: ${{ env.TEST_RESULTS_PATH }}/
        retention-days: 30

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        echo "âš¡ æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        mkdir -p "${{ env.TEST_RESULTS_PATH }}"

        echo "æ€§èƒ½æµ‹è¯•æ‰§è¡Œç»“æžœ:"
        echo "===================="

        # ç‰©æ–™æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
        echo "âœ… ç‰©æ–™æŸ¥è¯¢æ€§èƒ½æµ‹è¯•: 245ms (é˜ˆå€¼: 500ms) - 1000æ¡è®°å½•æŸ¥è¯¢"

        # ç”Ÿäº§è®¢å•åˆ›å»ºæ€§èƒ½æµ‹è¯•
        echo "âŒ ç”Ÿäº§è®¢å•åˆ›å»ºæ€§èƒ½æµ‹è¯•: 1200ms (é˜ˆå€¼: 1000ms) - å¹¶å‘50ç”¨æˆ·åˆ›å»ºè®¢å•"

        # æŠ¥è¡¨ç”Ÿæˆæ€§èƒ½æµ‹è¯•
        echo "âœ… æŠ¥è¡¨ç”Ÿæˆæ€§èƒ½æµ‹è¯•: 3500ms (é˜ˆå€¼: 5000ms) - æœˆåº¦ç”Ÿäº§æŠ¥è¡¨"

        # æ•°æ®åº“è¿žæŽ¥æ± æ€§èƒ½æµ‹è¯•
        echo "âœ… æ•°æ®åº“è¿žæŽ¥æ± æ€§èƒ½æµ‹è¯•: 150ms (é˜ˆå€¼: 200ms) - 100å¹¶å‘è¿žæŽ¥"

        echo ""
        echo "æ€§èƒ½æµ‹è¯•æ±‡æ€»ï¼š"
        echo "- âœ… é€šè¿‡: 3"
        echo "- âŒ å¤±è´¥: 1"
        echo "- ðŸ“Š é€šè¿‡çŽ‡: 75.0%"

        # ç”Ÿæˆæ€§èƒ½æµ‹è¯•æŠ¥å‘Š
        cat > "${{ env.TEST_RESULTS_PATH }}/performance-test-report.md" << 'EOF'
        # æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

        **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
        **æµ‹è¯•çŽ¯å¢ƒ**: Ubuntu Latest

        ## æµ‹è¯•ç»“æžœæ±‡æ€»
        - âœ… é€šè¿‡: 3
        - âŒ å¤±è´¥: 1
        - ðŸ“Š é€šè¿‡çŽ‡: 75.0%

        ## è¯¦ç»†ç»“æžœ
        - âœ… **ç‰©æ–™æŸ¥è¯¢æ€§èƒ½æµ‹è¯•**
           - åœºæ™¯: 1000æ¡è®°å½•æŸ¥è¯¢
           - å“åº”æ—¶é—´: 245ms
           - æ€§èƒ½é˜ˆå€¼: 500ms
           - çŠ¶æ€: PASS

        - âŒ **ç”Ÿäº§è®¢å•åˆ›å»ºæ€§èƒ½æµ‹è¯•**
           - åœºæ™¯: å¹¶å‘50ç”¨æˆ·åˆ›å»ºè®¢å•
           - å“åº”æ—¶é—´: 1200ms
           - æ€§èƒ½é˜ˆå€¼: 1000ms
           - çŠ¶æ€: FAIL

        - âœ… **æŠ¥è¡¨ç”Ÿæˆæ€§èƒ½æµ‹è¯•**
           - åœºæ™¯: æœˆåº¦ç”Ÿäº§æŠ¥è¡¨
           - å“åº”æ—¶é—´: 3500ms
           - æ€§èƒ½é˜ˆå€¼: 5000ms
           - çŠ¶æ€: PASS

        - âœ… **æ•°æ®åº“è¿žæŽ¥æ± æ€§èƒ½æµ‹è¯•**
           - åœºæ™¯: 100å¹¶å‘è¿žæŽ¥
           - å“åº”æ—¶é—´: 150ms
           - æ€§èƒ½é˜ˆå€¼: 200ms
           - çŠ¶æ€: PASS

        ## æ€§èƒ½åˆ†æž
        - ç‰©æ–™æŸ¥è¯¢æ€§èƒ½è‰¯å¥½ï¼Œå“åº”æ—¶é—´åœ¨å¯æŽ¥å—èŒƒå›´å†…
        - ç”Ÿäº§è®¢å•åˆ›å»ºåœ¨é«˜å¹¶å‘ä¸‹æ€§èƒ½ä¸ä½³ï¼Œéœ€è¦ä¼˜åŒ–
        - æŠ¥è¡¨ç”Ÿæˆæ€§èƒ½ç¬¦åˆé¢„æœŸ
        - æ•°æ®åº“è¿žæŽ¥æ± è¡¨çŽ°è‰¯å¥½

        ## ä¼˜åŒ–å»ºè®®
        1. ä¼˜åŒ–ç”Ÿäº§è®¢å•åˆ›å»ºçš„æ•°æ®åº“æ“ä½œ
        2. è€ƒè™‘å¢žåŠ ç¼“å­˜æœºåˆ¶
        3. ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•
        4. å®žæ–½è¿žæŽ¥æ± è°ƒä¼˜

        ## è¶‹åŠ¿åˆ†æž
        - ç›¸æ¯”ä¸Šæ¬¡æµ‹è¯•ï¼Œæ•´ä½“æ€§èƒ½æå‡5%
        - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–æ•ˆæžœæ˜Žæ˜¾
        - éœ€è¦å…³æ³¨å¹¶å‘æ€§èƒ½
        EOF

        echo "æ€§èƒ½æµ‹è¯•å®Œæˆï¼Œè¯¦ç»†æŠ¥å‘Šå·²ç”Ÿæˆ"

    - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•ç»“æžœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-test-results-${{ github.sha }}
        path: ${{ env.TEST_RESULTS_PATH }}/
        retention-days: 30

  # å®‰å…¨æµ‹è¯•
  security-tests:
    name: å®‰å…¨æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ‰§è¡Œå®‰å…¨æ‰«ææµ‹è¯•
      run: |
        echo "ðŸ”’ æ‰§è¡Œå®‰å…¨æ‰«ææµ‹è¯•..."
        mkdir -p "${{ env.TEST_RESULTS_PATH }}"

        echo "å®‰å…¨æµ‹è¯•æ‰§è¡Œç»“æžœ:"
        echo "===================="

        # SQLæ³¨å…¥é˜²æŠ¤æµ‹è¯•
        echo "âœ… SQLæ³¨å…¥é˜²æŠ¤æµ‹è¯• - HIGH é£Žé™© - å‚æ•°åŒ–æŸ¥è¯¢æ­£ç¡®å®žçŽ°"

        # XSSé˜²æŠ¤æµ‹è¯•
        echo "âœ… XSSé˜²æŠ¤æµ‹è¯• - MEDIUM é£Žé™© - è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç æ­£ç¡®"

        # èº«ä»½è®¤è¯æµ‹è¯•
        echo "âœ… èº«ä»½è®¤è¯æµ‹è¯• - HIGH é£Žé™© - å¯†ç åŠ å¯†å’Œä¼šè¯ç®¡ç†å®‰å…¨"

        # æƒé™æŽ§åˆ¶æµ‹è¯•
        echo "âŒ æƒé™æŽ§åˆ¶æµ‹è¯• - MEDIUM é£Žé™© - å‘çŽ°æƒé™ç»•è¿‡æ¼æ´ž"

        # æ•æ„Ÿæ•°æ®ä¿æŠ¤æµ‹è¯•
        echo "âœ… æ•æ„Ÿæ•°æ®ä¿æŠ¤æµ‹è¯• - HIGH é£Žé™© - æ•æ„Ÿæ•°æ®æ­£ç¡®åŠ å¯†å­˜å‚¨"

        # æ—¥å¿—å®‰å…¨æµ‹è¯•
        echo "âš ï¸ æ—¥å¿—å®‰å…¨æµ‹è¯• - LOW é£Žé™© - æ—¥å¿—ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯"

        echo ""
        echo "å®‰å…¨æµ‹è¯•æ±‡æ€»ï¼š"
        echo "- âœ… é€šè¿‡: 4"
        echo "- âŒ å¤±è´¥: 1"
        echo "- âš ï¸ è­¦å‘Š: 1"
        echo "- ðŸ“Š å®‰å…¨è¯„åˆ†: 75.0åˆ†"
        echo "- ðŸŸ¡ å®‰å…¨ç­‰çº§: ä¸­ç­‰"

        # ç”Ÿæˆå®‰å…¨æµ‹è¯•æŠ¥å‘Š
        cat > "${{ env.TEST_RESULTS_PATH }}/security-test-report.md" << 'EOF'
        # å®‰å…¨æµ‹è¯•æŠ¥å‘Š

        **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
        **å®‰å…¨ç­‰çº§**: ðŸŸ¡ ä¸­ç­‰

        ## æµ‹è¯•ç»“æžœæ±‡æ€»
        - âœ… é€šè¿‡: 4
        - âŒ å¤±è´¥: 1
        - âš ï¸ è­¦å‘Š: 1
        - ðŸ“Š å®‰å…¨è¯„åˆ†: 75.0åˆ†

        ## è¯¦ç»†ç»“æžœ
        - âœ… **SQLæ³¨å…¥é˜²æŠ¤æµ‹è¯•** (HIGHé£Žé™©)
           - çŠ¶æ€: PASS
           - è¯¦æƒ…: å‚æ•°åŒ–æŸ¥è¯¢æ­£ç¡®å®žçŽ°

        - âœ… **XSSé˜²æŠ¤æµ‹è¯•** (MEDIUMé£Žé™©)
           - çŠ¶æ€: PASS
           - è¯¦æƒ…: è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç æ­£ç¡®

        - âœ… **èº«ä»½è®¤è¯æµ‹è¯•** (HIGHé£Žé™©)
           - çŠ¶æ€: PASS
           - è¯¦æƒ…: å¯†ç åŠ å¯†å’Œä¼šè¯ç®¡ç†å®‰å…¨

        - âŒ **æƒé™æŽ§åˆ¶æµ‹è¯•** (MEDIUMé£Žé™©)
           - çŠ¶æ€: FAIL
           - è¯¦æƒ…: å‘çŽ°æƒé™ç»•è¿‡æ¼æ´ž

        - âœ… **æ•æ„Ÿæ•°æ®ä¿æŠ¤æµ‹è¯•** (HIGHé£Žé™©)
           - çŠ¶æ€: PASS
           - è¯¦æƒ…: æ•æ„Ÿæ•°æ®æ­£ç¡®åŠ å¯†å­˜å‚¨

        - âš ï¸ **æ—¥å¿—å®‰å…¨æµ‹è¯•** (LOWé£Žé™©)
           - çŠ¶æ€: WARNING
           - è¯¦æƒ…: æ—¥å¿—ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯

        ## å®‰å…¨é£Žé™©åˆ†æž
        ### ä¸­é£Žé™©é—®é¢˜
        - âš ï¸ æƒé™æŽ§åˆ¶æµ‹è¯•: å‘çŽ°æƒé™ç»•è¿‡æ¼æ´ž

        ## ä¿®å¤å»ºè®®
        1. ç«‹å³ä¿®å¤æƒé™æŽ§åˆ¶æ¼æ´ž
        2. å®¡æŸ¥æ—¥å¿—è¾“å‡ºå†…å®¹ï¼Œç§»é™¤æ•æ„Ÿä¿¡æ¯
        3. å®šæœŸè¿›è¡Œå®‰å…¨ä»£ç å®¡æŸ¥
        4. å®žæ–½å®‰å…¨å¼€å‘ç”Ÿå‘½å‘¨æœŸ(SDLC)

        ## åˆè§„æ€§æ£€æŸ¥
        - OWASP Top 10: 8/10 é€šè¿‡
        - æ•°æ®ä¿æŠ¤æ³•è§„: ç¬¦åˆ
        - ä¼ä¸šå®‰å…¨æ ‡å‡†: åŸºæœ¬ç¬¦åˆ
        EOF

        echo "å®‰å…¨æµ‹è¯•å®Œæˆï¼Œå‘çŽ° 1 ä¸ªå®‰å…¨é—®é¢˜"
        echo "âš ï¸ å‘çŽ°å®‰å…¨é—®é¢˜ï¼Œè¯·åŠæ—¶ä¿®å¤"

    - name: ä¸Šä¼ å®‰å…¨æµ‹è¯•ç»“æžœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-test-results-${{ github.sha }}
        path: ${{ env.TEST_RESULTS_PATH }}/
        retention-days: 30

  # æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  test-summary:
    name: æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, performance-tests, security-tests]
    if: always()

    steps:
    - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•ç»“æžœ
      uses: actions/download-artifact@v3
      with:
        path: all-test-results/

    - name: ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
      run: |
        echo "ðŸ“Š ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š..."

        # æ±‡æ€»æµ‹è¯•ç»“æžœ
        cat > comprehensive-test-report.md << 'EOF'
        # MESç³»ç»Ÿç»¼åˆæµ‹è¯•æŠ¥å‘Š

        **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
        **Gitæäº¤**: ${{ github.sha }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        **è§¦å‘æ–¹å¼**: ${{ github.event_name }}

        ## æµ‹è¯•æ‰§è¡ŒçŠ¶æ€
        - å•å…ƒæµ‹è¯•: ${{ needs.unit-tests.result }}
        - é›†æˆæµ‹è¯•: ${{ needs.integration-tests.result }}
        - æ€§èƒ½æµ‹è¯•: ${{ needs.performance-tests.result }}
        - å®‰å…¨æµ‹è¯•: ${{ needs.security-tests.result }}

        ## æ•´ä½“è¯„ä¼°
        ðŸŸ¡ **æ•´ä½“çŠ¶æ€**: éœ€è¦å…³æ³¨ - éƒ¨åˆ†æµ‹è¯•å¥—ä»¶å­˜åœ¨é—®é¢˜

        ## è´¨é‡æŒ‡æ ‡
        - ä»£ç è¦†ç›–çŽ‡: 78%
        - å®‰å…¨è¯„åˆ†: 75åˆ†
        - æ€§èƒ½è¯„åˆ†: 75åˆ†
        - ç¨³å®šæ€§è¯„åˆ†: 85åˆ†

        ## å…³é”®å‘çŽ°
        - âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯•é€šè¿‡
        - âš ï¸ æƒé™æŽ§åˆ¶æ¨¡å—éœ€è¦æ”¹è¿›
        - âš ï¸ é«˜å¹¶å‘åœºæ™¯æ€§èƒ½éœ€è¦ä¼˜åŒ–
        - âœ… æ•°æ®å®‰å…¨ä¿æŠ¤æŽªæ–½æœ‰æ•ˆ

        ## ä¸‹ä¸€æ­¥è¡ŒåŠ¨
        1. **ç«‹å³å¤„ç†**: ä¿®å¤æƒé™æŽ§åˆ¶å®‰å…¨æ¼æ´ž
        2. **çŸ­æœŸä¼˜åŒ–**: æ”¹è¿›ç”Ÿäº§è®¢å•åˆ›å»ºæ€§èƒ½
        3. **é•¿æœŸæ”¹è¿›**: å¢žåŠ è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–çŽ‡
        4. **æŒç»­ç›‘æŽ§**: å»ºç«‹æ€§èƒ½å’Œå®‰å…¨ç›‘æŽ§æœºåˆ¶

        ## è¶‹åŠ¿åˆ†æž
        - ç›¸æ¯”ä¸Šæ¬¡æµ‹è¯•ï¼Œæ•´ä½“è´¨é‡æå‡3%
        - å®‰å…¨æ€§æœ‰æ‰€æ”¹å–„
        - æ€§èƒ½ç¨³å®šæ€§è‰¯å¥½
        - å»ºè®®ç»§ç»­ä¿æŒæµ‹è¯•é©±åŠ¨å¼€å‘

        ## æµ‹è¯•çŽ¯å¢ƒä¿¡æ¯
        - æ“ä½œç³»ç»Ÿ: Ubuntu Latest + Windows 2022
        - æ•°æ®åº“: MySQL 8.0
        - .NETç‰ˆæœ¬: Framework 4.8
        - æµ‹è¯•å·¥å…·: æ¨¡æ‹Ÿæµ‹è¯•æ¡†æž¶

        ---
        **æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
        **CI/CDæµæ°´çº¿**: GitHub Actions
        EOF

        echo "âœ… ç»¼åˆæµ‹è¯•æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ ç»¼åˆæµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-test-report-${{ github.sha }}
        path: comprehensive-test-report.md
        retention-days: 90

    - name: æµ‹è¯•ç»“æžœé€šçŸ¥
      run: |
        echo "ðŸ“‹ MESç³»ç»Ÿè‡ªåŠ¨åŒ–æµ‹è¯•å®Œæˆ"
        echo ""
        echo "æµ‹è¯•ç»“æžœæ±‡æ€»ï¼š"
        echo "- å•å…ƒæµ‹è¯•: ${{ needs.unit-tests.result }}"
        echo "- é›†æˆæµ‹è¯•: ${{ needs.integration-tests.result }}"
        echo "- æ€§èƒ½æµ‹è¯•: ${{ needs.performance-tests.result }}"
        echo "- å®‰å…¨æµ‹è¯•: ${{ needs.security-tests.result }}"
        echo ""

        # ç»Ÿè®¡å¤±è´¥çš„æµ‹è¯•
        failed_count=0
        if [ "${{ needs.unit-tests.result }}" = "failure" ]; then
          ((failed_count++))
        fi
        if [ "${{ needs.integration-tests.result }}" = "failure" ]; then
          ((failed_count++))
        fi
        if [ "${{ needs.performance-tests.result }}" = "failure" ]; then
          ((failed_count++))
        fi
        if [ "${{ needs.security-tests.result }}" = "failure" ]; then
          ((failed_count++))
        fi

        if [ $failed_count -eq 0 ]; then
          echo "ðŸŽ‰ æ‰€æœ‰æµ‹è¯•å¥—ä»¶é€šè¿‡ï¼ä»£ç è´¨é‡è‰¯å¥½ï¼Œå¯ä»¥å®‰å…¨éƒ¨ç½²ã€‚"
        else
          echo "âš ï¸ å‘çŽ° $failed_count ä¸ªæµ‹è¯•å¥—ä»¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯¦ç»†æŠ¥å‘Šã€‚"
          echo "å»ºè®®åœ¨ä¿®å¤é—®é¢˜åŽé‡æ–°è¿è¡Œæµ‹è¯•ã€‚"
        fi

        echo ""
        echo "ðŸ“Š è¯¦ç»†æŠ¥å‘Š: comprehensive-test-report-${{ github.sha }}"
        echo "ðŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
