name: MESé¡¹ç›®CI/CDæµæ°´çº¿

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop, main ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'test'
        type: choice
        options:
        - test
        - staging
        - production

env:
  DOTNET_VERSION: '4.8'
  BUILD_CONFIGURATION: 'Release'
  SOLUTION_FILE: 'MES.sln'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: windows-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºåˆ†æ

    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
        $csharpFiles = Get-ChildItem -Path "src" -Filter "*.cs" -Recurse
        $issues = @()

        foreach ($file in $csharpFiles) {
          $content = Get-Content $file.FullName -Raw

          # æ£€æŸ¥ç¼–ç æ ¼å¼
          if ($content -match '\t') {
            $issues += "âŒ $($file.Name): ä½¿ç”¨äº†Tabå­—ç¬¦ï¼Œåº”ä½¿ç”¨ç©ºæ ¼"
          }

          # æ£€æŸ¥è¡Œå°¾ç©ºæ ¼
          if ($content -match ' +\r?\n') {
            $issues += "âš ï¸ $($file.Name): å­˜åœ¨è¡Œå°¾ç©ºæ ¼"
          }

          # æ£€æŸ¥ä¸­æ–‡æ³¨é‡Šç¼–ç 
          if ($content -match '[\u4e00-\u9fa5]' -and $content -notmatch 'UTF-8') {
            Write-Host "âœ… $($file.Name): åŒ…å«ä¸­æ–‡æ³¨é‡Š"
          }
        }

        if ($issues.Count -eq 0) {
          echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
        } else {
          echo "å‘ç°ä»£ç æ ¼å¼é—®é¢˜ï¼š"
          $issues | ForEach-Object { echo $_ }
        }

    - name: é¡¹ç›®ç»“æ„éªŒè¯
      run: |
        echo "ğŸ—ï¸ éªŒè¯é¡¹ç›®ç»“æ„..."
        $requiredDirs = @("src/MES.Common", "src/MES.Models", "src/MES.DAL", "src/MES.BLL", "src/MES.UI")
        $missingDirs = @()

        foreach ($dir in $requiredDirs) {
          if (-not (Test-Path $dir)) {
            $missingDirs += $dir
          } else {
            echo "âœ… $dir å­˜åœ¨"
          }
        }

        if ($missingDirs.Count -gt 0) {
          echo "âŒ ç¼ºå°‘å¿…è¦ç›®å½•ï¼š"
          $missingDirs | ForEach-Object { echo "  - $_" }
          exit 1
        } else {
          echo "âœ… é¡¹ç›®ç»“æ„éªŒè¯é€šè¿‡"
        }

  # æ„å»ºæµ‹è¯•
  build:
    name: æ„å»ºæµ‹è¯•
    runs-on: windows-latest
    needs: code-quality

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: è®¾ç½®NuGet
      uses: nuget/setup-nuget@v1
      with:
        nuget-version: 'latest'

    - name: ç¼“å­˜NuGetåŒ…
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: è¿˜åŸNuGetåŒ…
      run: |
        echo "ğŸ“¦ è¿˜åŸNuGetåŒ…..."
        nuget restore ${{ env.SOLUTION_FILE }}

    - name: æ„å»ºè§£å†³æ–¹æ¡ˆ
      run: |
        echo "ğŸ”¨ æ„å»ºMESè§£å†³æ–¹æ¡ˆ..."
        msbuild ${{ env.SOLUTION_FILE }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform="Any CPU" /p:WarningLevel=0

        if ($LASTEXITCODE -eq 0) {
          echo "âœ… è§£å†³æ–¹æ¡ˆæ„å»ºæˆåŠŸ"
        } else {
          echo "âŒ è§£å†³æ–¹æ¡ˆæ„å»ºå¤±è´¥"
          exit 1
        }

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        if (Test-Path "tests") {
          echo "å‘ç°æµ‹è¯•é¡¹ç›®ï¼Œæ‰§è¡Œæµ‹è¯•..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„æµ‹è¯•æ‰§è¡Œå‘½ä»¤
          echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
        } else {
          echo "âš ï¸ æœªå‘ç°æµ‹è¯•é¡¹ç›®ï¼Œè·³è¿‡å•å…ƒæµ‹è¯•"
        }

    - name: ç”Ÿæˆæ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“ æ”¶é›†æ„å»ºäº§ç‰©..."
        $artifactPath = "build-artifacts"
        New-Item -ItemType Directory -Path $artifactPath -Force

        # å¤åˆ¶ä¸»è¦çš„æ„å»ºè¾“å‡º
        $binPaths = @(
          "src/MES.Common/bin/${{ env.BUILD_CONFIGURATION }}",
          "src/MES.Models/bin/${{ env.BUILD_CONFIGURATION }}",
          "src/MES.DAL/bin/${{ env.BUILD_CONFIGURATION }}",
          "src/MES.BLL/bin/${{ env.BUILD_CONFIGURATION }}",
          "src/MES.UI/bin/${{ env.BUILD_CONFIGURATION }}"
        )

        foreach ($path in $binPaths) {
          if (Test-Path $path) {
            $projectName = Split-Path (Split-Path $path -Parent) -Leaf
            $targetPath = Join-Path $artifactPath $projectName
            Copy-Item -Path $path -Destination $targetPath -Recurse -Force
            echo "âœ… å·²å¤åˆ¶ $projectName æ„å»ºè¾“å‡º"
          }
        }

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: mes-build-${{ github.sha }}
        path: build-artifacts/
        retention-days: 30

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: windows-latest
    needs: build
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¾èµ–å®‰å…¨æ‰«æ
      run: |
        echo "ğŸ”’ æ‰§è¡Œä¾èµ–å®‰å…¨æ‰«æ..."

        # æ£€æŸ¥packages.configæ–‡ä»¶ä¸­çš„å·²çŸ¥æ¼æ´åŒ…
        $packagesFiles = Get-ChildItem -Path "src" -Filter "packages.config" -Recurse
        $vulnerablePackages = @(
          "Newtonsoft.Json/12.0.1",  # ç¤ºä¾‹ï¼šå·²çŸ¥æœ‰æ¼æ´çš„ç‰ˆæœ¬
          "System.Data.SqlClient/4.6.0"
        )

        $foundIssues = @()
        foreach ($file in $packagesFiles) {
          $content = Get-Content $file.FullName
          foreach ($vuln in $vulnerablePackages) {
            if ($content -match $vuln) {
              $foundIssues += "âš ï¸ å‘ç°æ½œåœ¨å®‰å…¨é£é™©: $vuln in $($file.Name)"
            }
          }
        }

        if ($foundIssues.Count -eq 0) {
          echo "âœ… æœªå‘ç°å·²çŸ¥å®‰å…¨æ¼æ´"
        } else {
          echo "å‘ç°å®‰å…¨é—®é¢˜ï¼š"
          $foundIssues | ForEach-Object { echo $_ }
          echo "å»ºè®®æ›´æ–°åˆ°å®‰å…¨ç‰ˆæœ¬"
        }

    - name: ä»£ç å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ›¡ï¸ æ‰§è¡Œä»£ç å®‰å…¨æ£€æŸ¥..."
        $csharpFiles = Get-ChildItem -Path "src" -Filter "*.cs" -Recurse
        $securityIssues = @()

        foreach ($file in $csharpFiles) {
          $content = Get-Content $file.FullName -Raw

          # æ£€æŸ¥SQLæ³¨å…¥é£é™©
          if ($content -match 'string.*sql.*\+.*' -or $content -match 'CommandText.*\+') {
            $securityIssues += "âš ï¸ $($file.Name): å¯èƒ½å­˜åœ¨SQLæ³¨å…¥é£é™©ï¼Œå»ºè®®ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢"
          }

          # æ£€æŸ¥ç¡¬ç¼–ç å¯†ç 
          if ($content -match 'password\s*=\s*["\'][^"\']+["\']' -or $content -match 'pwd\s*=\s*["\'][^"\']+["\']') {
            $securityIssues += "ğŸ”´ $($file.Name): å‘ç°ç¡¬ç¼–ç å¯†ç ï¼Œå­˜åœ¨å®‰å…¨é£é™©"
          }

          # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ—¥å¿—
          if ($content -match 'Log.*password|Log.*pwd|Console.*password') {
            $securityIssues += "âš ï¸ $($file.Name): å¯èƒ½åœ¨æ—¥å¿—ä¸­è¾“å‡ºæ•æ„Ÿä¿¡æ¯"
          }
        }

        if ($securityIssues.Count -eq 0) {
          echo "âœ… ä»£ç å®‰å…¨æ£€æŸ¥é€šè¿‡"
        } else {
          echo "å‘ç°å®‰å…¨é—®é¢˜ï¼š"
          $securityIssues | ForEach-Object { echo $_ }
        }

  # éƒ¨ç½²å‡†å¤‡
  deploy-prepare:
    name: éƒ¨ç½²å‡†å¤‡
    runs-on: windows-latest
    needs: [build, security-scan]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: mes-build-${{ github.sha }}
        path: build-artifacts/

    - name: åˆ›å»ºéƒ¨ç½²åŒ…
      run: |
        echo "ğŸ“¦ åˆ›å»ºéƒ¨ç½²åŒ…..."
        $deployPath = "deploy-package"
        New-Item -ItemType Directory -Path $deployPath -Force

        # å¤åˆ¶åº”ç”¨ç¨‹åºæ–‡ä»¶
        Copy-Item -Path "build-artifacts/*" -Destination $deployPath -Recurse -Force

        # å¤åˆ¶æ•°æ®åº“è„šæœ¬
        if (Test-Path "database") {
          Copy-Item -Path "database" -Destination "$deployPath/database" -Recurse -Force
          echo "âœ… å·²åŒ…å«æ•°æ®åº“è„šæœ¬"
        }

        # å¤åˆ¶é…ç½®æ–‡ä»¶æ¨¡æ¿
        if (Test-Path "configs") {
          Copy-Item -Path "configs" -Destination "$deployPath/configs" -Recurse -Force
          echo "âœ… å·²åŒ…å«é…ç½®æ–‡ä»¶æ¨¡æ¿"
        }

        # åˆ›å»ºéƒ¨ç½²è¯´æ˜
        @"
        # MESç³»ç»Ÿéƒ¨ç½²åŒ…

        æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        Gitæäº¤: ${{ github.sha }}
        åˆ†æ”¯: ${{ github.ref_name }}

        ## éƒ¨ç½²æ­¥éª¤
        1. è§£å‹éƒ¨ç½²åŒ…åˆ°ç›®æ ‡ç›®å½•
        2. æ‰§è¡Œdatabase/mysql/ç›®å½•ä¸‹çš„SQLè„šæœ¬
        3. ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
        4. è¿è¡ŒMES.UI.exeå¯åŠ¨åº”ç”¨ç¨‹åº

        ## æ³¨æ„äº‹é¡¹
        - ç¡®ä¿ç›®æ ‡æœåŠ¡å™¨å·²å®‰è£….NET Framework 4.8
        - ç¡®ä¿MySQL 8.0æœåŠ¡æ­£å¸¸è¿è¡Œ
        - é¦–æ¬¡éƒ¨ç½²éœ€è¦æ‰§è¡Œå®Œæ•´çš„æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
        "@ | Out-File -FilePath "$deployPath/éƒ¨ç½²è¯´æ˜.txt" -Encoding UTF8

        echo "âœ… éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆ"

    - name: ä¸Šä¼ éƒ¨ç½²åŒ…
      uses: actions/upload-artifact@v3
      with:
        name: mes-deploy-package-${{ github.sha }}
        path: deploy-package/
        retention-days: 90

  # é€šçŸ¥
  notify:
    name: æ„å»ºé€šçŸ¥
    runs-on: windows-latest
    needs: [code-quality, build, security-scan, deploy-prepare]
    if: always()

    steps:
    - name: æ„å»ºç»“æœé€šçŸ¥
      run: |
        echo "ğŸ“Š MESé¡¹ç›®CI/CDæµæ°´çº¿æ‰§è¡Œå®Œæˆ"
        echo ""
        echo "æ‰§è¡Œç»“æœï¼š"
        echo "- ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}"
        echo "- æ„å»ºæµ‹è¯•: ${{ needs.build.result }}"
        echo "- å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}"
        echo "- éƒ¨ç½²å‡†å¤‡: ${{ needs.deploy-prepare.result }}"
        echo ""

        if ("${{ needs.build.result }}" -eq "success") {
          echo "âœ… æ„å»ºæˆåŠŸï¼å¯ä»¥è¿›è¡Œéƒ¨ç½²"
          echo "ğŸ“¦ æ„å»ºäº§ç‰©: mes-build-${{ github.sha }}"
          if ("${{ needs.deploy-prepare.result }}" -eq "success") {
            echo "ğŸ“¦ éƒ¨ç½²åŒ…: mes-deploy-package-${{ github.sha }}"
          }
        } else {
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"
        }

        echo ""
        echo "ğŸ”— æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"