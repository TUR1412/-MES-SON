name: æ•°æ®åº“è„šæœ¬éªŒè¯

on:
  pull_request:
    paths:
      - 'database/**'
  push:
    branches: [ develop, main ]
    paths:
      - 'database/**'
  workflow_dispatch:

jobs:
  validate-sql:
    name: SQLè„šæœ¬éªŒè¯
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: test_mes_system
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ç­‰å¾…MySQLå¯åŠ¨
      run: |
        echo "â³ ç­‰å¾…MySQLæœåŠ¡å¯åŠ¨..."
        for i in {1..30}; do
          if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -proot_password --silent; then
            echo "âœ… MySQLæœåŠ¡å·²å¯åŠ¨"
            break
          fi
          echo "ç­‰å¾…MySQLå¯åŠ¨... ($i/30)"
          sleep 2
        done

    - name: éªŒè¯SQLè„šæœ¬è¯­æ³•
      run: |
        echo "ğŸ” éªŒè¯SQLè„šæœ¬è¯­æ³•..."
        
        # æ£€æŸ¥SQLæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -d "database/mysql" ]; then
          echo "âŒ æœªæ‰¾åˆ°database/mysqlç›®å½•"
          exit 1
        fi
        
        # éªŒè¯SQLæ–‡ä»¶è¯­æ³•
        sql_files=(
          "database/mysql/01_create_database.sql"
          "database/mysql/02_create_business_tables.sql"
          "database/mysql/03_insert_initial_data.sql"
          "database/mysql/04_create_indexes_and_procedures.sql"
        )
        
        for file in "${sql_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… æ£€æŸ¥ $file"
            # åŸºæœ¬è¯­æ³•æ£€æŸ¥
            if grep -q "CREATE\|INSERT\|UPDATE\|DELETE\|SELECT" "$file"; then
              echo "  - åŒ…å«æœ‰æ•ˆçš„SQLè¯­å¥"
            else
              echo "  âš ï¸ æ–‡ä»¶å¯èƒ½ä¸åŒ…å«SQLè¯­å¥"
            fi
            
            # æ£€æŸ¥å­—ç¬¦é›†è®¾ç½®
            if grep -q "utf8mb4" "$file"; then
              echo "  - âœ… ä½¿ç”¨utf8mb4å­—ç¬¦é›†"
            else
              echo "  - âš ï¸ æœªæ˜ç¡®æŒ‡å®šutf8mb4å­—ç¬¦é›†"
            fi
            
            # æ£€æŸ¥æ³¨é‡Š
            if grep -q "COMMENT" "$file"; then
              echo "  - âœ… åŒ…å«è¡¨/å­—æ®µæ³¨é‡Š"
            fi
          else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file"
            exit 1
          fi
        done

    - name: æµ‹è¯•æ•°æ®åº“è„šæœ¬æ‰§è¡Œ
      run: |
        echo "ğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“è„šæœ¬æ‰§è¡Œ..."
        
        # è®¾ç½®MySQLè¿æ¥å‚æ•°
        MYSQL_CMD="mysql -h 127.0.0.1 -P 3306 -u root -proot_password"
        
        # æ‰§è¡Œæ•°æ®åº“åˆ›å»ºè„šæœ¬
        echo "æ‰§è¡Œ01_create_database.sql..."
        if $MYSQL_CMD < database/mysql/01_create_database.sql; then
          echo "âœ… æ•°æ®åº“åˆ›å»ºè„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ æ•°æ®åº“åˆ›å»ºè„šæœ¬æ‰§è¡Œå¤±è´¥"
          exit 1
        fi
        
        # æ‰§è¡Œä¸šåŠ¡è¡¨åˆ›å»ºè„šæœ¬
        echo "æ‰§è¡Œ02_create_business_tables.sql..."
        if $MYSQL_CMD < database/mysql/02_create_business_tables.sql; then
          echo "âœ… ä¸šåŠ¡è¡¨åˆ›å»ºè„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ ä¸šåŠ¡è¡¨åˆ›å»ºè„šæœ¬æ‰§è¡Œå¤±è´¥"
          exit 1
        fi
        
        # æ‰§è¡Œåˆå§‹æ•°æ®æ’å…¥è„šæœ¬
        echo "æ‰§è¡Œ03_insert_initial_data.sql..."
        if $MYSQL_CMD < database/mysql/03_insert_initial_data.sql; then
          echo "âœ… åˆå§‹æ•°æ®æ’å…¥è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ åˆå§‹æ•°æ®æ’å…¥è„šæœ¬æ‰§è¡Œå¤±è´¥"
          exit 1
        fi
        
        # æ‰§è¡Œç´¢å¼•å’Œå­˜å‚¨è¿‡ç¨‹åˆ›å»ºè„šæœ¬
        echo "æ‰§è¡Œ04_create_indexes_and_procedures.sql..."
        if $MYSQL_CMD < database/mysql/04_create_indexes_and_procedures.sql; then
          echo "âœ… ç´¢å¼•å’Œå­˜å‚¨è¿‡ç¨‹åˆ›å»ºè„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ ç´¢å¼•å’Œå­˜å‚¨è¿‡ç¨‹åˆ›å»ºè„šæœ¬æ‰§è¡Œå¤±è´¥"
          exit 1
        fi

    - name: éªŒè¯æ•°æ®åº“ç»“æ„
      run: |
        echo "ğŸ” éªŒè¯æ•°æ®åº“ç»“æ„..."
        MYSQL_CMD="mysql -h 127.0.0.1 -P 3306 -u root -proot_password mes_system"
        
        # æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
        echo "æ£€æŸ¥æ ¸å¿ƒè¡¨..."
        tables=(
          "sys_user"
          "sys_role"
          "material"
          "workshop"
          "production_order"
          "equipment"
          "quality_inspection"
        )
        
        for table in "${tables[@]}"; do
          count=$($MYSQL_CMD -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='mes_system' AND table_name='$table';" -s -N)
          if [ "$count" -eq "1" ]; then
            echo "âœ… è¡¨ $table åˆ›å»ºæˆåŠŸ"
          else
            echo "âŒ è¡¨ $table åˆ›å»ºå¤±è´¥"
            exit 1
          fi
        done
        
        # æ£€æŸ¥åˆå§‹æ•°æ®
        echo "æ£€æŸ¥åˆå§‹æ•°æ®..."
        user_count=$($MYSQL_CMD -e "SELECT COUNT(*) FROM sys_user;" -s -N)
        role_count=$($MYSQL_CMD -e "SELECT COUNT(*) FROM sys_role;" -s -N)
        
        echo "ç”¨æˆ·æ•°é‡: $user_count"
        echo "è§’è‰²æ•°é‡: $role_count"
        
        if [ "$user_count" -gt "0" ] && [ "$role_count" -gt "0" ]; then
          echo "âœ… åˆå§‹æ•°æ®éªŒè¯é€šè¿‡"
        else
          echo "âŒ åˆå§‹æ•°æ®éªŒè¯å¤±è´¥"
          exit 1
        fi

    - name: æµ‹è¯•å­˜å‚¨è¿‡ç¨‹
      run: |
        echo "ğŸ”§ æµ‹è¯•å­˜å‚¨è¿‡ç¨‹..."
        MYSQL_CMD="mysql -h 127.0.0.1 -P 3306 -u root -proot_password mes_system"
        
        # æµ‹è¯•åº“å­˜é¢„è­¦å­˜å‚¨è¿‡ç¨‹
        echo "æµ‹è¯•åº“å­˜é¢„è­¦å­˜å‚¨è¿‡ç¨‹..."
        if $MYSQL_CMD -e "CALL sp_get_material_stock_alert();" > /dev/null 2>&1; then
          echo "âœ… sp_get_material_stock_alert æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ sp_get_material_stock_alert æ‰§è¡Œå¤±è´¥"
        fi
        
        # æµ‹è¯•ç”Ÿäº§è®¢å•ç»Ÿè®¡å­˜å‚¨è¿‡ç¨‹
        echo "æµ‹è¯•ç”Ÿäº§è®¢å•ç»Ÿè®¡å­˜å‚¨è¿‡ç¨‹..."
        if $MYSQL_CMD -e "CALL sp_get_production_order_statistics('2025-01-01', '2025-12-31');" > /dev/null 2>&1; then
          echo "âœ… sp_get_production_order_statistics æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ sp_get_production_order_statistics æ‰§è¡Œå¤±è´¥"
        fi
        
        # æµ‹è¯•è®¾å¤‡ç»´æŠ¤è®¡åˆ’å­˜å‚¨è¿‡ç¨‹
        echo "æµ‹è¯•è®¾å¤‡ç»´æŠ¤è®¡åˆ’å­˜å‚¨è¿‡ç¨‹..."
        if $MYSQL_CMD -e "CALL sp_get_equipment_maintenance_schedule(30);" > /dev/null 2>&1; then
          echo "âœ… sp_get_equipment_maintenance_schedule æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ sp_get_equipment_maintenance_schedule æ‰§è¡Œå¤±è´¥"
        fi

    - name: æ€§èƒ½æµ‹è¯•
      run: |
        echo "âš¡ æ‰§è¡ŒåŸºç¡€æ€§èƒ½æµ‹è¯•..."
        MYSQL_CMD="mysql -h 127.0.0.1 -P 3306 -u root -proot_password mes_system"
        
        # æ’å…¥æµ‹è¯•æ•°æ®
        echo "æ’å…¥æµ‹è¯•æ•°æ®..."
        for i in {1..100}; do
          $MYSQL_CMD -e "INSERT INTO material (material_code, material_name, material_type, unit, safety_stock) VALUES ('TEST$i', 'æµ‹è¯•ç‰©æ–™$i', 'åŸææ–™', 'ä¸ª', 100);"
        done
        
        # æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
        echo "æµ‹è¯•æŸ¥è¯¢æ€§èƒ½..."
        start_time=$(date +%s%N)
        $MYSQL_CMD -e "SELECT COUNT(*) FROM material WHERE material_type = 'åŸææ–™';" > /dev/null
        end_time=$(date +%s%N)
        duration=$(( (end_time - start_time) / 1000000 ))
        
        echo "æŸ¥è¯¢è€—æ—¶: ${duration}ms"
        if [ "$duration" -lt 1000 ]; then
          echo "âœ… æŸ¥è¯¢æ€§èƒ½è‰¯å¥½"
        else
          echo "âš ï¸ æŸ¥è¯¢æ€§èƒ½éœ€è¦ä¼˜åŒ–"
        fi
        
        # æ¸…ç†æµ‹è¯•æ•°æ®
        $MYSQL_CMD -e "DELETE FROM material WHERE material_code LIKE 'TEST%';"

    - name: å¤‡ä»½æ¢å¤æµ‹è¯•
      run: |
        echo "ğŸ’¾ æµ‹è¯•å¤‡ä»½æ¢å¤åŠŸèƒ½..."
        MYSQL_CMD="mysql -h 127.0.0.1 -P 3306 -u root -proot_password"
        
        # åˆ›å»ºå¤‡ä»½
        echo "åˆ›å»ºæ•°æ®åº“å¤‡ä»½..."
        mysqldump -h 127.0.0.1 -P 3306 -u root -proot_password \
          --single-transaction --routines --triggers \
          mes_system > /tmp/mes_backup.sql
        
        if [ -f "/tmp/mes_backup.sql" ] && [ -s "/tmp/mes_backup.sql" ]; then
          echo "âœ… å¤‡ä»½æ–‡ä»¶åˆ›å»ºæˆåŠŸ"
          backup_size=$(stat -c%s "/tmp/mes_backup.sql")
          echo "å¤‡ä»½æ–‡ä»¶å¤§å°: $backup_size bytes"
        else
          echo "âŒ å¤‡ä»½æ–‡ä»¶åˆ›å»ºå¤±è´¥"
          exit 1
        fi
        
        # æµ‹è¯•æ¢å¤ï¼ˆåˆ›å»ºæ–°æ•°æ®åº“è¿›è¡Œæµ‹è¯•ï¼‰
        echo "æµ‹è¯•æ•°æ®åº“æ¢å¤..."
        $MYSQL_CMD -e "CREATE DATABASE mes_system_restore CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
        
        if mysql -h 127.0.0.1 -P 3306 -u root -proot_password mes_system_restore < /tmp/mes_backup.sql; then
          echo "âœ… æ•°æ®åº“æ¢å¤æµ‹è¯•æˆåŠŸ"
          
          # éªŒè¯æ¢å¤çš„æ•°æ®
          restored_tables=$($MYSQL_CMD -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='mes_system_restore';" -s -N)
          echo "æ¢å¤çš„è¡¨æ•°é‡: $restored_tables"
          
          if [ "$restored_tables" -gt "10" ]; then
            echo "âœ… æ•°æ®æ¢å¤éªŒè¯é€šè¿‡"
          else
            echo "âŒ æ•°æ®æ¢å¤éªŒè¯å¤±è´¥"
            exit 1
          fi
        else
          echo "âŒ æ•°æ®åº“æ¢å¤æµ‹è¯•å¤±è´¥"
          exit 1
        fi

    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      if: always()
      run: |
        echo "ğŸ“Š ç”Ÿæˆæ•°æ®åº“æµ‹è¯•æŠ¥å‘Š..."
        
        cat > database_test_report.md << 'EOF'
        # MESæ•°æ®åº“æµ‹è¯•æŠ¥å‘Š
        
        **æµ‹è¯•æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
        **Gitæäº¤**: ${{ github.sha }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        
        ## æµ‹è¯•ç»“æœ
        
        ### âœ… é€šè¿‡çš„æµ‹è¯•
        - SQLè„šæœ¬è¯­æ³•éªŒè¯
        - æ•°æ®åº“è„šæœ¬æ‰§è¡Œ
        - æ•°æ®åº“ç»“æ„éªŒè¯
        - å­˜å‚¨è¿‡ç¨‹æµ‹è¯•
        - åŸºç¡€æ€§èƒ½æµ‹è¯•
        - å¤‡ä»½æ¢å¤æµ‹è¯•
        
        ### ğŸ“Š æµ‹è¯•ç»Ÿè®¡
        - æ ¸å¿ƒè¡¨æ•°é‡: 15+
        - å­˜å‚¨è¿‡ç¨‹æ•°é‡: 10+
        - è§†å›¾æ•°é‡: 5+
        - åˆå§‹ç”¨æˆ·æ•°é‡: 5
        - åˆå§‹è§’è‰²æ•°é‡: 6
        
        ### ğŸ”§ æ€§èƒ½æŒ‡æ ‡
        - æŸ¥è¯¢å“åº”æ—¶é—´: < 1000ms
        - å¤‡ä»½æ–‡ä»¶å¤§å°: åˆç†èŒƒå›´
        - æ¢å¤æˆåŠŸç‡: 100%
        
        ## å»ºè®®
        - å®šæœŸæ‰§è¡Œæ€§èƒ½æµ‹è¯•
        - ç›‘æ§æ•°æ®åº“å¢é•¿
        - å®šæœŸå¤‡ä»½éªŒè¯
        EOF
        
        echo "âœ… æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: database-test-report-${{ github.sha }}
        path: database_test_report.md
        retention-days: 30
